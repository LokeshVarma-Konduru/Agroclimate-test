<!DOCTYPE html>
<html>
<head>
    <title>Agroclimate Viewer & Planner App</title>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YLRKCN2672"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        
        // Configure GA4 with session settings
        gtag('config', 'G-YLRKCN2672', {
            'session_duration': 1800,  // 30 minutes in seconds
            'custom_map': {
                'dimension1': 'user_type'
            }
        });

        // Bot detection
        function isBot() {
            return /bot|googlebot|crawler|spider|robot|crawling/i.test(navigator.userAgent);
        }

        // Set persistent user property
        gtag('set', 'user_properties', {
            'user_type': isBot() ? 'bot' : 'real_user'
        });

        // Custom event tracking function with session handling
        function trackEvent(action, category, label) {
            console.log('Sending event:', action, {
                event_category: category,
                event_label: label,
                user_type: isBot() ? 'bot' : 'real_user',
                non_interaction: false  // Ensures event affects session duration
            });

            gtag('event', action, {
                event_category: category,
                event_label: label,
                user_type: isBot() ? 'bot' : 'real_user',
                non_interaction: false
            });
        }

        // Track initial page view with session data
        gtag('event', 'page_view', {
            user_type: isBot() ? 'bot' : 'real_user',
            page_title: document.title,
            page_location: window.location.href,
            non_interaction: false
        });

        // Periodic activity tracking to maintain session
        setInterval(function() {
            if (document.visibilityState === 'visible') {
                gtag('event', 'active_check', {
                    user_type: isBot() ? 'bot' : 'real_user',
                    non_interaction: true
                });
            }
        }, 60000);  // Check every minute

        console.log('Analytics initialized with user_type:', isBot() ? 'bot' : 'real_user');
    </script>
</head>
<body style="margin:0; padding:0;">
    <iframe id="geeApp" style="width:100%; height:100vh; border:none;"></iframe>

    <script>
        // Function to handle messages from the GEE app
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'analytics') {
                trackEvent(event.data.action, event.data.category, event.data.label);
            }
        });

        // Load the GEE app and track the load
        window.onload = function() {
            trackEvent('app_load', 'system', 'GEE App Loaded');
            var iframe = document.getElementById('geeApp');
            iframe.src = 'https://our-axon-435300-d4.projects.earthengine.app/view/agroclimate-v1';
        };
    </script>
</body>
</html>
