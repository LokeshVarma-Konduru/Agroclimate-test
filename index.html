<!DOCTYPE html>
<html>
<head>
    <title>Agroclimate Viewer & Planner App</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-analytics.js";
        import { getDatabase, ref, set, onValue, increment } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAIo80sL0dRdsI7wnBqWjG4s9gCM6eX6s8",
            authDomain: "agroclimate-analytics.firebaseapp.com",
            projectId: "agroclimate-analytics",
            storageBucket: "agroclimate-analytics.firebasestorage.app",
            messagingSenderId: "38181017178",
            appId: "1:38181017178:web:581278e2d21d39873e7c4",
            measurementId: "G-DRVWFWG1B3",
            databaseURL: "https://agroclimate-analytics-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);

        // Generate a unique user ID for this session
        const userId = Date.now().toString(36) + Math.random().toString(36).substr(2);
        
        // Get today's date in YYYY-MM-DD format
        const today = new Date().toISOString().split('T')[0];

        // Track daily unique users
        async function trackDailyUser() {
            const dailyUsersRef = ref(database, `daily-users/${today}`);
            const userRef = ref(database, `daily-users/${today}/users/${userId}`);
            
            // Mark this user as active today
            await set(userRef, true);

            // Listen for total users count
            onValue(dailyUsersRef, (snapshot) => {
                const data = snapshot.val();
                const totalUsers = data?.users ? Object.keys(data.users).length : 0;
                console.log(`Total users today: ${totalUsers}`);
                
                // Log the daily total users event
                analytics.logEvent('daily_total_users', {
                    date: today,
                    total_users: totalUsers
                });
            });
        }

        // Track real-time active users
        let activeUsers = new Set();
        
        function updateActiveUsers() {
            const activeUsersRef = ref(database, 'active-users');
            
            // Add this user
            activeUsers.add(userId);
            set(activeUsersRef, Array.from(activeUsers));
            
            // Remove user when they leave
            window.addEventListener('beforeunload', () => {
                activeUsers.delete(userId);
                set(activeUsersRef, Array.from(activeUsers));
            });
        }

        // Initialize tracking
        trackDailyUser();
        updateActiveUsers();

        // Track page views
        analytics.logEvent('page_view', {
            page_title: document.title,
            page_location: window.location.href,
            user_id: userId
        });

        // Track user engagement
        let sessionStartTime = Date.now();
        
        // Track session duration
        setInterval(() => {
            const sessionDuration = Math.floor((Date.now() - sessionStartTime) / 1000);
            analytics.logEvent('user_engagement', {
                engagement_time: sessionDuration,
                type: 'user',
                user_id: userId
            });
        }, 60000); // Log every minute

        // Track GEE app interactions
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'analytics') {
                analytics.logEvent('gee_interaction', {
                    action: event.data.action,
                    category: event.data.category,
                    label: event.data.label || '',
                    user_id: userId
                });
            }
        });
    </script>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YLRKCN2672"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        
        // Configure GA4 with enhanced measurement and historical data collection
        gtag('config', 'G-YLRKCN2672', {
            debug_mode: false, // Disable debug mode in production
            send_page_view: true,
            cookie_domain: 'auto',
            cookie_flags: 'SameSite=None;Secure',
            custom_map: {
                'dimension1': 'user_type',    // User scope
                'dimension2': 'event_session', // Event scope (renamed from session_ids)
                'metric1': 'event_engagement' // Event scope
            }
        });

        // Session management
        const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes
        let lastActivity = Date.now();
        let sessionId = Date.now().toString();

        // Bot detection
        function isBot() {
            return /bot|googlebot|crawler|spider|robot|crawling/i.test(navigator.userAgent);
        }

        // Track user engagement with enhanced data retention
        function updateEngagement() {
            if (document.visibilityState === 'visible') {
                const now = Date.now();
                const timeSinceLastActivity = now - lastActivity;
                
                // If session expired, create new session
                if (timeSinceLastActivity > SESSION_TIMEOUT) {
                    sessionId = now.toString();
                    gtag('event', 'session_start', {
                        user_type: isBot() ? 'bot' : 'real_user',
                        session_ids: sessionId,
                        non_interaction: false
                    });
                }
                
                lastActivity = now;
                
                // Track engagement with enhanced parameters
                gtag('event', 'user_engagement', {
                    engagement_time_msec: Math.min(timeSinceLastActivity, SESSION_TIMEOUT),
                    session_ids: sessionId,
                    user_type: isBot() ? 'bot' : 'real_user',
                    non_interaction: false,
                    send_to: 'G-YLRKCN2672'
                });
            }
        }

        // Enhanced event tracking with improved data retention
        function trackEvent(eventData) {
            console.log('Tracking event:', eventData);
            
            // Ensure required fields
            if (!eventData.action || !eventData.category) {
                console.error('Missing required event fields');
                return;
            }

            // Build event parameters with enhanced tracking
            const params = {
                event_category: eventData.category,
                event_label: eventData.label || '',
                value: eventData.value || 1,
                user_type: isBot() ? 'bot' : 'real_user',
                session_ids: sessionId,
                engagement_time_msec: Date.now() - lastActivity,
                non_interaction: false,
                send_to: 'G-YLRKCN2672'
            };

            // Send to GA4 with improved data collection
            gtag('event', eventData.action, params);
            
            // Update activity timestamp
            lastActivity = Date.now();
        }

        // Initialize tracking
        document.addEventListener('visibilitychange', updateEngagement);
        setInterval(updateEngagement, 60000); // Check engagement every minute

        // Track initial page load with enhanced parameters
        gtag('event', 'page_view', {
            page_title: document.title,
            page_location: window.location.href,
            user_type: isBot() ? 'bot' : 'real_user',
            session_ids: sessionId,
            non_interaction: false,
            send_to: 'G-YLRKCN2672'
        });
    </script>
</head>
<body style="margin:0; padding:0;">
    <iframe id="geeApp" style="width:100%; height:100vh; border:none;"></iframe>

    <script>
        // Handle messages from GEE app with improved tracking
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'analytics') {
                // Track the event from GEE with enhanced parameters
                trackEvent(event.data);
            }
        });

        // Load GEE app
        window.onload = function() {
            var iframe = document.getElementById('geeApp');
            iframe.src = 'https://our-axon-435300-d4.projects.earthengine.app/view/agroclimate-v1';
            
            // Track iframe load with enhanced parameters
            iframe.onload = function() {
                trackEvent({
                    action: 'iframe_loaded',
                    category: 'system',
                    label: 'GEE App Loaded',
                    non_interaction: false
                });
            };
        };
    </script>
</body>
</html>
